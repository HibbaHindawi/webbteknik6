function init(){saveUserId().then(()=>{document.getElementById("usernameTag").textContent=localStorage.getItem("username");showList()})}window.addEventListener("DOMContentLoaded",init);
async function showList(){try{if(localStorage.getItem("userid")){var a=await fetch("https://melab.lnu.se/~hh223ji/uppgift/public/lists");if(!a.ok)throw Error("HTTP error! Status:"+a.status);var b=await a.text();try{var d=JSON.parse(b)}catch(c){throw Error("Invalid JSON response: "+b);}var e=document.getElementById("listBox");e.innerHTML="";Array.isArray(d)&&0!==d.length?d.forEach(c=>{c=createListElement(c);e.appendChild(c)}):e.innerHTML="<p id='errorMsg'>Du har inga listor, testa skapa nya</p>"}else console.error("No user ID found in localStorage.")}catch(c){console.error("Error loading lists:",
c)}}
function createListElement(a){var b=localStorage.getItem("userid");const d=document.createElement("div");d.classList.add("list");var e=document.createElement("div");e.classList.add("listInfo");var c=document.createElement("p");c.textContent=a.name;c.classList.add("listName");const f=document.createElement("p");f.textContent=a.username;f.classList.add("listOwner");e.append(c,f);d.appendChild(e);e=document.createElement("div");e.classList.add("shareBtn");e.innerHTML="<p>Dela Lista</p>";e.addEventListener("click",h=>
{h.stopPropagation();openShareDialog(a.id)});a.ownerid===b&&(b=document.createElement("div"),b.classList.add("trashDiv"),b.addEventListener("click",h=>{h.stopPropagation();deleteList(a.id)}),c=document.createElement("img"),c.src="https://melab.lnu.se/~hh223ji/uppgift/public/images/trash.png",c.classList.add("trashImg"),b.appendChild(c),d.appendChild(b));d.append(e);d.addEventListener("click",()=>redirectPage(a.id));return d}
async function openShareDialog(a){try{const b=await fetch("https://melab.lnu.se/~hh223ji/uppgift/public/lists/"+a+"/share");if(!b.ok)throw Error("HTTP error! Status:"+b.status);const d=await b.json(),e=document.getElementById("shareDialog");e.showModal();e.innerHTML="";const c=document.createElement("button");c.textContent="X";c.classList.add("closeDialog");c.addEventListener("click",()=>e.close());const f=document.createElement("p");f.textContent="https://melab.lnu.se/~hh223ji/uppgift/public/share/"+
d.token;const h=document.createElement("button");h.textContent="Copy Link";h.classList.add("copyBtn");h.addEventListener("click",()=>{navigator.clipboard.writeText(f.textContent).then(()=>alert("L\u00e4nk kopierad!")).catch(g=>alert("Misslyckades med att kopiera: "+g))});e.append(c,f,h)}catch(b){console.error("Error generating share link:",b)}}function redirectPage(a){window.location.href="https://melab.lnu.se/~hh223ji/uppgift/public/lists/"+a}
async function deleteList(a){try{const b=await fetch("https://melab.lnu.se/~hh223ji/uppgift/public/lists/"+a,{method:"POST"});if(!b.ok)throw Error("HTTP error! Status:"+b.status);showList()}catch(b){console.error("Error deleting list:",b)}}
async function saveUserId(){try{const a=await fetch("https://melab.lnu.se/~hh223ji/uppgift/public/user",{method:"GET"});if(!a.ok)throw Error("HTTP error! Status:"+a.status);const b=await a.json();localStorage.setItem("userid",b.id);localStorage.setItem("username",b.username)}catch(a){console.error("Error fetching user data:",a)}};async function checkLoginStatus(){try{if(!(await (await fetch("https://melab.lnu.se/~hh223ji/uppgift/public/checkLogin")).json()).loggedIn)throw Error("User not logged in");}catch(a){console.error("Redirecting due to login status:",a),window.location.replace("https://melab.lnu.se/~hh223ji/uppgift/public/login.php")}}checkLoginStatus();function init(){document.getElementById("logoutBtn").addEventListener("click",logout)}window.addEventListener("DOMContentLoaded",init);function logout(){localStorage.removeItem("userid");fetch("https://melab.lnu.se/~hh223ji/uppgift/public/logout",{method:"POST"}).then(a=>a.json()).then(a=>{a.success?window.location.href="https://melab.lnu.se/~hh223ji/uppgift/public/login.php":console.error("Logout failed:",a.message)}).catch(a=>console.error("Error during logout:",a))};function init(){const a=document.getElementById("createListDialog"),b=document.querySelector(".closeDialog"),d=document.getElementById("newList"),e=document.getElementById("listForm");d.addEventListener("click",()=>{a.showModal();e.addEventListener("submit",createList)});b.addEventListener("click",()=>a.close())}window.addEventListener("DOMContentLoaded",init);
function createList(a){a.preventDefault();(a=document.getElementById("listName").value.trim())?fetch("https://melab.lnu.se/~hh223ji/uppgift/public/lists",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a})}).then(b=>b.json()).then(b=>{b.listId?window.location.href="https://melab.lnu.se/~hh223ji/uppgift/public/lists/"+b.listId:console.error("Error: List ID not received.")}).catch(b=>console.error("Error creating list:",b)):alert("Du beh\u00f6ver namnge listan")}
;async function init(){document.getElementById("usernameTag").textContent=localStorage.getItem("username");await checkUserAccess();getData()}window.addEventListener("DOMContentLoaded",init);
async function checkUserAccess(){var a=window.location.href.split("/");a=a[a.length-1];if(localStorage.getItem("userid"))try{let b=await fetch("https://melab.lnu.se/~hh223ji/uppgift/public/lists/"+a+"/members");b.ok?(await b.json()).isMember||(window.location.href="https://melab.lnu.se/~hh223ji/uppgift/public/index.html"):window.location.href="https://melab.lnu.se/~hh223ji/uppgift/public/index.html"}catch(b){window.location.href="https://melab.lnu.se/~hh223ji/uppgift/public/index.html"}else window.location.href=
"https://melab.lnu.se/~hh223ji/uppgift/public/index.html"}
async function loadTasks(){var a=window.location.pathname.split("/");a=a[a.length-1];const b=localStorage.getItem("userid");try{let d=await (await fetch("https://melab.lnu.se/~hh223ji/uppgift/public/lists/"+a+"/tasks")).json();const e=document.getElementById("taskList");e.innerHTML="";if(0===d.length){let c=document.createElement("p");c.id="errorMsg";c.textContent="Det finns inga uppgifter, testa l\u00e4gga till nya uppgifter";e.appendChild(c)}d.forEach(c=>{const f=document.createElement("div");f.classList.add("task");
"1"==c.status&&f.classList.add("completed");const h=document.createElement("div");h.classList="task-left";const g=document.createElement("input");g.type="checkbox";g.id=c.id;g.name=c.name;1==c.status&&(g.checked=!0);var k=document.createElement("div"),l=document.createElement("label");l.textContent="Namn: "+c.name+" - Po\u00e4ng: "+c.points;l.setAttribute("for",c.id);const m=document.createElement("p");m.innerHTML="<b>Beskrivning:</b> "+c.description;const n=document.createElement("p");n.innerHTML=
null!=c.completeUsername?"<b>Skapad av:</b> "+c.creatorUsername+" | <b>Klarad av:</b> "+c.completeUsername:"<b>Skapad av:</b> "+c.creatorUsername;k.appendChild(l);k.appendChild(m);k.appendChild(n);h.appendChild(g);h.appendChild(k);k=document.createElement("div");l=document.createElement("img");l.src="https://melab.lnu.se/~hh223ji/uppgift/public/images/trash.png";l.classList="trash";k.appendChild(l);k.addEventListener("click",()=>{!0===g.checked&&c.completeUser!==b?alert("Bara anv\u00e4ndaren som klarade uppgiften kan radera detta."):
deleteTask(c.id)});f.appendChild(h);f.appendChild(k);g.addEventListener("change",function(){!1===g.checked&&c.completeUser!==b?(alert("Bara anv\u00e4ndaren som klarade uppgiften kan avmarkera detta."),g.checked=!0):updateTaskStatus(c.id,g.checked?1:0)});f.addEventListener("click",p=>{"INPUT"===p.target.tagName||p.target.classList.contains("trash")||(g.checked=!g.checked,!1===g.checked&&c.completeUser!==b?(alert("Bara anv\u00e4ndaren som klarade uppgiften kan avmarkera den."),g.checked=!0):updateTaskStatus(c.id,
g.checked?1:0))});e.appendChild(f);getUsers()})}catch(d){console.error("Error loading tasks:",d)}}
async function submitTask(a){a.preventDefault();a=document.getElementById("taskText");let b=document.getElementById("taskPoints"),d=document.getElementById("taskDescription");var e=window.location.pathname.split("/");e=e[e.length-1];const c=document.getElementById("charCount");try{let f=await (await fetch("https://melab.lnu.se/~hh223ji/uppgift/public/lists/"+e+"/tasks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a.value,points:b.value,description:d.value,listId:e})})).json();
f.message?(a.value="",b.value="",d.value="",c.textContent="0 / 200",loadTasks()):console.error("Error creating task:",f.error)}catch(f){console.error("Error creating task:",f)}}
async function updateTaskStatus(a,b){var d=window.location.pathname.split("/");d=d[d.length-1];const e=localStorage.getItem("userid");try{await fetch("https://melab.lnu.se/~hh223ji/uppgift/public/tasks/"+a+"/status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({taskStatus:b,listId:d,userId:e})}),loadTasks()}catch(c){console.error("Error updating task status:",c)}}
async function deleteTask(a){var b=window.location.href.split("/");b=b[b.length-1];try{await fetch("https://melab.lnu.se/~hh223ji/uppgift/public/tasks/"+a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({listId:b})}),loadTasks()}catch(d){console.error("Error deleting task:",d)}}
async function getUsers(){var a=window.location.pathname.split("/");a=a[a.length-1];try{let b=await (await fetch("https://melab.lnu.se/~hh223ji/uppgift/public/lists/"+a+"/users")).json(),d=document.getElementById("users");d.innerHTML="";b.forEach(e=>{let c=document.createElement("li");c.textContent=e.username+" - Po\u00e4ng: "+e.total_points;d.appendChild(c)})}catch(b){console.error("Error loading users:",b)}}
async function getData(){var a=window.location.href.split("/");a=a[a.length-1];try{let b=await fetch("https://melab.lnu.se/~hh223ji/uppgift/public/lists/"+a+"/data");if(!b.ok)throw Error("Error fetching list data: "+b.status);let d=await b.json();d.error?console.error("Error from backend:",d.error):(updatePageContent(d),getUsers())}catch(b){console.error("Error getting list info:",b)}}
function updatePageContent(a){let b=document.querySelector("body");var d=document.createElement("h1");d.textContent=a.name;b.appendChild(d);a=document.createElement("a");a.id="backBtn";a.href="https://melab.lnu.se/~hh223ji/uppgift/public/index.html";a.innerHTML="&#8678; Huvudsida";b.appendChild(a);a=document.createElement("button");a.innerHTML="Ny Uppgift &#43;";a.id="newTask";b.appendChild(a);let e=document.createElement("dialog");e.id="taskDialog";e.className="task-dialog";a.addEventListener("click",
()=>e.showModal());a=document.createElement("button");a.innerHTML="X";a.className="closeDialog";a.addEventListener("click",()=>e.close());e.appendChild(a);a=document.createElement("form");a.id="taskForm";a.addEventListener("submit",m=>{m.preventDefault();submitTask(m);e.close()});d=document.createElement("div");d.className="row";var c=document.createElement("label");c.setAttribute("for","taskText");c.textContent="Namn:";var f=document.createElement("input");f.id="taskText";f.type="text";f.maxLength=
20;f.required=!0;var h=document.createElement("label");h.setAttribute("for","taskPoints");h.textContent="Po\u00e4ng (1-20):";let g=document.createElement("input");g.id="taskPoints";g.type="number";g.min=1;g.max=20;g.required=!0;d.append(c,f,h,g);c=document.createElement("label");c.setAttribute("for","taskDescription");c.textContent="Beskrivning:";f=document.createElement("div");f.className="desc-wrapper";let k=document.createElement("textarea");k.id="taskDescription";k.rows=6;k.maxLength=200;k.required=
!0;let l=document.createElement("span");l.id="charCount";l.textContent="0 / 200";k.addEventListener("input",()=>{l.textContent=k.value.length+" / 200"});f.append(k,l);h=document.createElement("input");h.type="submit";h.value="Skapa Uppgift";a.append(d,c,f,h);e.appendChild(a);b.appendChild(e);a=document.createElement("div");a.id="taskList";d=document.createElement("ul");d.id="users";c=document.createElement("div");c.id="contentWrapper";c.append(a,d);b.appendChild(c);loadTasks()};
